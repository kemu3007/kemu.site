{"url": "https://api.github.com/repos/kemu3007/portal/issues/27", "repository_url": "https://api.github.com/repos/kemu3007/portal", "labels_url": "https://api.github.com/repos/kemu3007/portal/issues/27/labels{/name}", "comments_url": "https://api.github.com/repos/kemu3007/portal/issues/27/comments", "events_url": "https://api.github.com/repos/kemu3007/portal/issues/27/events", "html_url": "https://github.com/kemu3007/portal/issues/27", "id": 1189790754, "node_id": "I_kwDOG7qoq85G6sQi", "number": 27, "title": "marked.jsとhighlight.jsでGitHub Flavored Markdownを扱う", "user": {"login": "kemu3007", "id": 29157528, "node_id": "MDQ6VXNlcjI5MTU3NTI4", "avatar_url": "https://avatars.githubusercontent.com/u/29157528?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kemu3007", "html_url": "https://github.com/kemu3007", "followers_url": "https://api.github.com/users/kemu3007/followers", "following_url": "https://api.github.com/users/kemu3007/following{/other_user}", "gists_url": "https://api.github.com/users/kemu3007/gists{/gist_id}", "starred_url": "https://api.github.com/users/kemu3007/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kemu3007/subscriptions", "organizations_url": "https://api.github.com/users/kemu3007/orgs", "repos_url": "https://api.github.com/users/kemu3007/repos", "events_url": "https://api.github.com/users/kemu3007/events{/privacy}", "received_events_url": "https://api.github.com/users/kemu3007/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 3898939400, "node_id": "LA_kwDOG7qoq87oZRgI", "url": "https://api.github.com/repos/kemu3007/portal/labels/article", "name": "article", "color": "C200E5", "default": false, "description": ""}, {"id": 3965428013, "node_id": "LA_kwDOG7qoq87sW6Et", "url": "https://api.github.com/repos/kemu3007/portal/labels/TypeScript", "name": "TypeScript", "color": "bfdadc", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-04-01T13:22:10Z", "updated_at": "2022-04-03T05:01:14Z", "closed_at": null, "author_association": "OWNER", "active_lock_reason": null, "body": "GitHub上で扱っているMarkdownの正式名称はGitHub Flavored Markdownと言われ、デフォルトのMarkdownを拡張した独自記法になっています。\r\n\r\n今回はhighlight.jsのGitHub cssを適用してMarkdownテキストをHTMLに変換します。\r\n\r\n[GitHub Flavored Markdown spec](https://github.github.com/gfm/)\r\n\r\n今回使用したライブラリ\r\n\r\n- [highlight.js](https://highlightjs.org/)\r\n- [marked.js](https://github.com/markedjs/marked)\r\n\r\n\r\n### 導入\r\n\r\n```bash\r\n$ npm i highlight.js marked\r\n```\r\ntipsのコードを実行する場合は `crypto-es` も同時にインストールしてください。\r\n\r\n#### GFMをHTMLに変換する\r\n\r\nMarkdownテキストをHTMLに変換し、コードブロックに対してhighlight.jsのcssがあたる様に設定します。\r\n\r\n```ts\r\nimport { marked } from 'marked';\r\nimport hljs from 'highlight.js';\r\n\r\nconst gfm_text = \"\"\r\n\r\nmarked.setOptions({\r\n  highlight: function (code, lang) {\r\n    const language = hljs.getLanguage(lang) ? lang : 'plaintext';\r\n    return hljs.highlight(code, { language }).value;\r\n  },\r\n  langPrefix: 'hljs language-',\r\n  gfm: true,\r\n  breaks: true,\r\n});\r\n\r\nmarkd.parse(gfm_text)\r\n```\r\n\r\n### highlight.jsのcss適用\r\n\r\nstyle.scss\r\n\r\n```scss\r\n@import '~highlight.js/styles/github.css';\r\n```\r\n\r\n---\r\n\r\nこれによりMarkdownをGitHub上と同じように表示することができます。コードブロックのbackground-colorが存在していないなどがある場合は適宜cssを追加して適用してください。\r\n\r\n```scss\r\n:host ::ng-deep pre > code {\r\n  background-color: #f6f8fa;\r\n  border-radius: 10px;\r\n}\r\n```\r\n\r\n---\r\n\r\ntips: 以下のような形でrendererを上書きしカスタマイズすることもできます。\r\n\r\n```ts\r\nimport { marked, Renderer } from 'marked';\r\nimport crypt from 'crypto-es';\r\nimport hljs from 'highlight.js';\r\n\r\nconst renderer = new Renderer();\r\n/** ヘッダーにはテキストのhash値から生成したフラグメント, リンクをコピーするボタンを追加する */\r\nrenderer.heading = (text, lebel) => {\r\n  const hash = crypt.MD5(text);\r\n  return `\r\n  <div class=\"d-flex\">\r\n    <h${lebel}\r\n      id=${hash}\r\n      style=\"border-left: solid 3px; border-color: darkturquoise; border-radius: 2px; padding-left: 5px;\"\r\n    >${text}</h${lebel}>\r\n    <button class=\"btn btn-sm\">\r\n      <i class=\"bi bi-clipboard\" onclick=\"window.navigator.clipboard.writeText('${window.location.origin}${window.location.pathname}#${hash}')\"></i>\r\n    </button>\r\n  </div>\r\n  `;\r\n};\r\n/** img要素にloading lazyを追加する */\r\nrenderer.image = (href) => `<img src=${href} loading=lazy />`;\r\n/** リンク要素にbootstrap iconのリンクマークを付与する */\r\nrenderer.link = (href, title, text) =>\r\n  `<a href=${href} class=\"text-muted\">${text}<i class=\"bi bi-link-45deg\"></i></a>`;\r\nmarked.setOptions({\r\n  renderer,\r\n  highlight: function (code, lang) {\r\n    const language = hljs.getLanguage(lang) ? lang : 'plaintext';\r\n    return hljs.highlight(code, { language }).value;\r\n  },\r\n  langPrefix: 'hljs language-',\r\n  gfm: true,\r\n  breaks: true,\r\n});\r\n\r\n```\r\n\r\nこれによりGFMをレンダリングすることができました。\r\n\r\n利用している実際のソースコードは[こちら](https://github.com/kemu3007/portal/blob/master/portal/src/app/shared/markdown/marked.service.ts)を参照してください。\r\n\r\n---\r\n\r\n修正履歴\r\n- crypto-jsはcommon js moduleのためECMAScript moduleのcrypto-esに移行\r\n", "reactions": {"url": "https://api.github.com/repos/kemu3007/portal/issues/27/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kemu3007/portal/issues/27/timeline", "performed_via_github_app": null}