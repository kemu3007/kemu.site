{"url": "https://api.github.com/repos/kemu3007/portal/issues/66", "repository_url": "https://api.github.com/repos/kemu3007/portal", "labels_url": "https://api.github.com/repos/kemu3007/portal/issues/66/labels{/name}", "comments_url": "https://api.github.com/repos/kemu3007/portal/issues/66/comments", "events_url": "https://api.github.com/repos/kemu3007/portal/issues/66/events", "html_url": "https://github.com/kemu3007/portal/issues/66", "id": 1814520108, "node_id": "I_kwDOG7qoq85sJ2Es", "number": 66, "title": "SAML Request / SAML Response を読む", "user": {"login": "kemu3007", "id": 29157528, "node_id": "MDQ6VXNlcjI5MTU3NTI4", "avatar_url": "https://avatars.githubusercontent.com/u/29157528?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kemu3007", "html_url": "https://github.com/kemu3007", "followers_url": "https://api.github.com/users/kemu3007/followers", "following_url": "https://api.github.com/users/kemu3007/following{/other_user}", "gists_url": "https://api.github.com/users/kemu3007/gists{/gist_id}", "starred_url": "https://api.github.com/users/kemu3007/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kemu3007/subscriptions", "organizations_url": "https://api.github.com/users/kemu3007/orgs", "repos_url": "https://api.github.com/users/kemu3007/repos", "events_url": "https://api.github.com/users/kemu3007/events{/privacy}", "received_events_url": "https://api.github.com/users/kemu3007/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 3898939400, "node_id": "LA_kwDOG7qoq87oZRgI", "url": "https://api.github.com/repos/kemu3007/portal/labels/article", "name": "article", "color": "C200E5", "default": false, "description": ""}, {"id": 3900078597, "node_id": "LA_kwDOG7qoq87odnoF", "url": "https://api.github.com/repos/kemu3007/portal/labels/Python", "name": "Python", "color": "1D76DB", "default": false, "description": ""}, {"id": 5766610674, "node_id": "LA_kwDOG7qoq88AAAABV7d-8g", "url": "https://api.github.com/repos/kemu3007/portal/labels/SAML", "name": "SAML", "color": "C6A29E", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-07-20T17:53:54Z", "updated_at": "2023-07-23T17:00:38Z", "closed_at": null, "author_association": "OWNER", "active_lock_reason": null, "body": "SAML Request 及び SAML Response は通常、Base64 エンコーディングが行われています。\r\n詳細な読み方についてメモ書きを残しておきますmm\r\n\r\n読解元となる Base64 文字列については開発者コンソール等より入手ください。[1]\r\n今回の検証には SP に Amazon Cognito を、SAML Idp に IAM Identity Center を利用しています。\r\n\r\n## SAML Request\r\n\r\nデコード方法例)\r\n```python\r\nimport base64, zlib\r\n\r\nraw_saml_request = input()\r\n\r\nprint(zlib.decompress(base64.b64decode(raw_saml_request.encode()), -zlib.MAX_WBITS).decode())\r\n```\r\n\r\n例)\r\n```xml\r\n<saml2p:AuthnRequest AssertionConsumerServiceURL=\"https://auth.trash-box.dev/saml2/idpresponse\"\r\n    Destination=\"https://portal.sso.ap-northeast-1.amazonaws.com/saml/assertion/***\"\r\n    ID=\"_b5e72b0e-e657-4a39-af2c-caebbf110754\" IssueInstant=\"2023-07-20T17:13:18.630Z\" Version=\"2.0\"\r\n    xmlns:saml2p=\"urn:oasis:names:tc:SAML:2.0:protocol\">\r\n    <saml2:Issuer Format=\"urn:oasis:names:tc:SAML:2.0:nameid-format:entity\"\r\n        xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\">\r\n        urn:amazon:cognito:sp:ap-northeast-1_***</saml2:Issuer>\r\n</saml2p:AuthnRequest>\r\n```\r\n\r\n## SAML Response\r\n\r\nデコード方法例)\r\n```python\r\nimport base64\r\n\r\nraw_saml_response = input()\r\n\r\nprint(base64.b64decode(raw_saml_response.encode()).decode())\r\n```\r\n例)\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<saml2p:Response xmlns:saml2p=\"urn:oasis:names:tc:SAML:2.0:protocol\"\r\n    xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\" xmlns:enc=\"http://www.w3.org/2001/04/xmlenc#\"\r\n    xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\"\r\n    Destination=\"https://auth.trash-box.dev/saml2/idpresponse\"\r\n    ID=\"_3e4ace15-c044-4061-9598-22d3e8290b97\" InResponseTo=\"_b5e72b0e-e657-4a39-af2c-caebbf110754\"\r\n    IssueInstant=\"2023-07-20T17:41:35.903Z\" Version=\"2.0\">\r\n    <saml2:Issuer Format=\"urn:oasis:names:tc:SAML:2.0:nameid-format:entity\">\r\n        https://portal.sso.ap-northeast-1.amazonaws.com/saml/assertion/***</saml2:Issuer>\r\n    <ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">\r\n        <ds:SignedInfo>\r\n            <ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" />\r\n            <ds:SignatureMethod Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\" />\r\n            <ds:Reference URI=\"#_3e4ace15-c044-4061-9598-22d3e8290b97\">\r\n                <ds:Transforms>\r\n                    <ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\" />\r\n                    <ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" />\r\n                </ds:Transforms>\r\n                <ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\" />\r\n                <ds:DigestValue>SAifI/KFD9/KTMCp2jS0pvdUKPIxffJoPjnY2UmwX8s=</ds:DigestValue>\r\n            </ds:Reference>\r\n        </ds:SignedInfo>\r\n        <ds:SignatureValue>***</ds:SignatureValue>\r\n        <ds:KeyInfo>\r\n            <ds:X509Data>\r\n                <ds:X509Certificate>***</ds:X509Certificate>\r\n            </ds:X509Data>\r\n        </ds:KeyInfo>\r\n    </ds:Signature>\r\n    <saml2p:Status>\r\n        <saml2p:StatusCode Value=\"urn:oasis:names:tc:SAML:2.0:status:Success\" />\r\n    </saml2p:Status>\r\n    <saml2:Assertion ID=\"_d60580b1-6f51-411b-a4ec-421acc2bce85\"\r\n        IssueInstant=\"2023-07-20T17:41:35.903Z\" Version=\"2.0\">\r\n        <saml2:Issuer Format=\"urn:oasis:names:tc:SAML:2.0:nameid-format:entity\">\r\n            https://portal.sso.ap-northeast-1.amazonaws.com/saml/assertion/***</saml2:Issuer>\r\n        <ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">\r\n            <ds:SignedInfo>\r\n                <ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" />\r\n                <ds:SignatureMethod Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\" />\r\n                <ds:Reference URI=\"#_d60580b1-6f51-411b-a4ec-421acc2bce85\">\r\n                    <ds:Transforms>\r\n                        <ds:Transform\r\n                            Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\" />\r\n                        <ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" />\r\n                    </ds:Transforms>\r\n                    <ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\" />\r\n                    <ds:DigestValue>QXbuUTHgAzfpKB0I/vnP7MuzEwGVe2Sno5ZQI77hYoY=</ds:DigestValue>\r\n                </ds:Reference>\r\n            </ds:SignedInfo>\r\n            <ds:SignatureValue>***</ds:SignatureValue>\r\n            <ds:KeyInfo>\r\n                <ds:X509Data>\r\n                    <ds:X509Certificate>***</ds:X509Certificate>\r\n                </ds:X509Data>\r\n            </ds:KeyInfo>\r\n        </ds:Signature>\r\n        <saml2:Subject>\r\n            <saml2:NameID Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\"\r\n                SPNameQualifier=\"urn:amazon:cognito:sp:ap-northeast-1_tsp7P2IZ5\">email</saml2:NameID>\r\n            <saml2:SubjectConfirmation Method=\"urn:oasis:names:tc:SAML:2.0:cm:bearer\">\r\n                <saml2:SubjectConfirmationData InResponseTo=\"_2e5c7690-25f2-4cd8-9dfe-6c3cf51f80d1\"\r\n                    NotOnOrAfter=\"2023-07-20T18:41:35.903Z\"\r\n                    Recipient=\"https://auth.trash-box.dev/saml2/idpresponse\" />\r\n            </saml2:SubjectConfirmation>\r\n        </saml2:Subject>\r\n        <saml2:Conditions NotBefore=\"2023-07-20T17:36:35.903Z\"\r\n            NotOnOrAfter=\"2023-07-20T18:41:35.903Z\">\r\n            <saml2:AudienceRestriction>\r\n                <saml2:Audience>urn:amazon:cognito:sp:ap-northeast-1_***</saml2:Audience>\r\n            </saml2:AudienceRestriction>\r\n        </saml2:Conditions>\r\n        <saml2:AuthnStatement AuthnInstant=\"2023-07-20T17:41:35.903Z\"\r\n            SessionIndex=\"_4088fa1e-35f6-4f4c-88ca-0c82912509cc\"\r\n            SessionNotOnOrAfter=\"2023-07-20T18:41:35.903Z\">\r\n            <saml2:AuthnContext>\r\n                <saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</saml2:AuthnContextClassRef>\r\n            </saml2:AuthnContext>\r\n        </saml2:AuthnStatement>\r\n        <saml2:AttributeStatement />\r\n    </saml2:Assertion>\r\n</saml2p:Response>\r\n```\r\n\r\n## あとがき\r\n\r\nSAML Request のデコード方法について記載されたドキュメントがパッと見当たらなかったためメモ書きとして残しておきます。\r\n\r\n---\r\n\r\n## 参考\r\n[1] トラブルシューティングのためにブラウザで SAML レスポンスを表示する方法 - https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/troubleshoot_saml_view-saml-response.html\r\n", "reactions": {"url": "https://api.github.com/repos/kemu3007/portal/issues/66/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kemu3007/portal/issues/66/timeline", "performed_via_github_app": null, "state_reason": null}