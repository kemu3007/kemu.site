{"url": "https://api.github.com/repos/kemu3007/portal/issues/42", "repository_url": "https://api.github.com/repos/kemu3007/portal", "labels_url": "https://api.github.com/repos/kemu3007/portal/issues/42/labels{/name}", "comments_url": "https://api.github.com/repos/kemu3007/portal/issues/42/comments", "events_url": "https://api.github.com/repos/kemu3007/portal/issues/42/events", "html_url": "https://github.com/kemu3007/portal/issues/42", "id": 1227975608, "node_id": "I_kwDOG7qoq85JMWu4", "number": 42, "title": "Cloudflare Pages 認証されたユーザにのみページを表示する", "user": {"login": "kemu3007", "id": 29157528, "node_id": "MDQ6VXNlcjI5MTU3NTI4", "avatar_url": "https://avatars.githubusercontent.com/u/29157528?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kemu3007", "html_url": "https://github.com/kemu3007", "followers_url": "https://api.github.com/users/kemu3007/followers", "following_url": "https://api.github.com/users/kemu3007/following{/other_user}", "gists_url": "https://api.github.com/users/kemu3007/gists{/gist_id}", "starred_url": "https://api.github.com/users/kemu3007/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kemu3007/subscriptions", "organizations_url": "https://api.github.com/users/kemu3007/orgs", "repos_url": "https://api.github.com/users/kemu3007/repos", "events_url": "https://api.github.com/users/kemu3007/events{/privacy}", "received_events_url": "https://api.github.com/users/kemu3007/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 3898939400, "node_id": "LA_kwDOG7qoq87oZRgI", "url": "https://api.github.com/repos/kemu3007/portal/labels/article", "name": "article", "color": "C200E5", "default": false, "description": ""}, {"id": 3900082041, "node_id": "LA_kwDOG7qoq87odod5", "url": "https://api.github.com/repos/kemu3007/portal/labels/%E3%81%9D%E3%81%AE%E4%BB%96", "name": "その他", "color": "BFDADC", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-05-06T14:59:25Z", "updated_at": "2022-05-06T15:19:57Z", "closed_at": null, "author_association": "OWNER", "active_lock_reason": null, "body": "\r\nGitHub Pagesで静的サイトをホストし、バックエンドを保持しない場合、ユーザ認証をかけることができないためCloudflare Pagesでデプロイを行い、Cloudflare Accessで認証を行い通過したユーザのみサイトを閲覧できるようにします。\r\n\r\n[Cloudflare - Webパフォーマンスとセキュリティを追求する企業 | Cloudflare](https://www.cloudflare.com/ja-jp/)\r\n\r\n## GitHub / GitLab 連携&デプロイ\r\n\r\nPushされたタイミングでデプロイがかかるよう設定することができ、以下の画面から選択することで自動的に連携されます。\r\n\r\nドメインがプロジェクトごとに割り振られ、そのサブドメインに各Pushされたブランチのプレビュー環境がデプロイされます。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/167156872-409ce84b-f912-44e3-83bc-1e4c37728dc8.png)\r\n\r\nSPAなどのビルドコマンドも設定可能です。この際注意点ですが、環境変数を設定しないとNodeのバージョンが自動的に12になるため環境変数で`NODE_VERSION`を指定する必要があります。\r\n\r\nPythonスクリプトを前処理で回すことも可能ですが3.8以上のインタプリタはイメージ上に存在していないため利用することができません。こちらも`PYTHON_VERSION`で指定する必要があります。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/167157817-3dd93ca1-fd8b-44d7-8bfc-06d703357f96.png)\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/167162708-2a5a77fd-7eec-4edd-9e18-55cce7702887.png)\r\n\r\nGitHub側からもPushしたタイミングで自動的に処理が走っていることが確認できます。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/167157214-336b032d-708e-4510-8592-473da8a4d5f0.png)\r\n\r\n## ユーザ認証\r\n\r\n`設定` -> `一般` -> `Access ポリシー` から設定を行います。\r\n\r\nプレビュー環境のドメインに対してポリシー設定を行う場合は `*.project.pages.dev`、本番環境に行う場合は `project.pages.dev`に対してのポリシーを作成します。\r\n\r\nこれにより以下のログイン画面が表示されるようになります。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/167158540-73cb3628-23b6-4f73-ba63-0abaaa405453.png)\r\n\r\n## 所感\r\n\r\nGitHub Pagesよりも手数はかかりますがユーザ認証が楽に実装でき、レポジトリとの連携に関しても悪くなさそうなのでなかなかいい気がする。（ちょっと管理画面が使いにくいかなというくらい）\r\n\r\n[Cloudflare Zero Trust](https://www.cloudflare.com/ja-jp/products/zero-trust/)の画面からはCloudflare Pagesのアプリケーションポリシーは作成できず、Pages側からポリシー作成しないといけないあたりが少しつまづきポイントと感じた。\r\n\r\n\r\n\r\n", "reactions": {"url": "https://api.github.com/repos/kemu3007/portal/issues/42/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kemu3007/portal/issues/42/timeline", "performed_via_github_app": null}