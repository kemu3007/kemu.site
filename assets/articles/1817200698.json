{"url": "https://api.github.com/repos/kemu3007/portal/issues/67", "repository_url": "https://api.github.com/repos/kemu3007/portal", "labels_url": "https://api.github.com/repos/kemu3007/portal/issues/67/labels{/name}", "comments_url": "https://api.github.com/repos/kemu3007/portal/issues/67/comments", "events_url": "https://api.github.com/repos/kemu3007/portal/issues/67/events", "html_url": "https://github.com/kemu3007/portal/issues/67", "id": 1817200698, "node_id": "I_kwDOG7qoq85sUEg6", "number": 67, "title": "AWS コンソールへのサインインが行われた場合に Slack 通知を行う", "user": {"login": "kemu3007", "id": 29157528, "node_id": "MDQ6VXNlcjI5MTU3NTI4", "avatar_url": "https://avatars.githubusercontent.com/u/29157528?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kemu3007", "html_url": "https://github.com/kemu3007", "followers_url": "https://api.github.com/users/kemu3007/followers", "following_url": "https://api.github.com/users/kemu3007/following{/other_user}", "gists_url": "https://api.github.com/users/kemu3007/gists{/gist_id}", "starred_url": "https://api.github.com/users/kemu3007/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kemu3007/subscriptions", "organizations_url": "https://api.github.com/users/kemu3007/orgs", "repos_url": "https://api.github.com/users/kemu3007/repos", "events_url": "https://api.github.com/users/kemu3007/events{/privacy}", "received_events_url": "https://api.github.com/users/kemu3007/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 3898939400, "node_id": "LA_kwDOG7qoq87oZRgI", "url": "https://api.github.com/repos/kemu3007/portal/labels/article", "name": "article", "color": "C200E5", "default": false, "description": ""}, {"id": 3951278401, "node_id": "LA_kwDOG7qoq87rg7lB", "url": "https://api.github.com/repos/kemu3007/portal/labels/AWS", "name": "AWS", "color": "EE0471", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2023-07-23T16:53:24Z", "updated_at": "2023-07-23T16:53:24Z", "closed_at": null, "author_association": "OWNER", "active_lock_reason": null, "body": "不正アクセス対策の一環とし、ConsoleLogin イベントの通知を行います。\r\nConsoleLogin イベントは以前まで us-east-1 リージョンでのみ発生し、EventBridge を利用して簡単に検出ができていたのですが、現時点ではサインイン時に利用されたリージョンにて発生するイベントとなっているため、少し凝った方法を利用する必要があります。\r\n\r\n方法として大きく二つ考えることが可能です。\r\n\r\n1. CloudTrail にてマルチリージョントレイルを作成し、CloudWatch Logs に出力。サブスクリプションフィルターから Lambda 関数を呼び出し通知処理を行う\r\n1. EventBridge ルールを各リージョンで作成し、通知処理をトリガーする\r\n\r\n今回は私用アカウントということもあり、手順およびコストを最小化したいものとなりますため、新機能である AWS User Notifications [1] を利用しました。\r\n\r\n## AWS User Notifications を使う\r\n\r\nAWS User Notifications を利用する場合、通知文章を変更することが現時点でできません。\r\nとりあえず攻撃されてないかノリでわかればいいや、という人におすすめです。\r\n\r\n## 設定内容\r\n\r\n### サービス名\r\n```txt\r\nAWS Console Sign-in\t\r\n``` \r\n\r\n### イベントタイプ\r\n```txt\r\nAWS Console Sign In via CloudTrail\t\r\n```\r\n\r\n### イベントパターン JSON\r\n```json\r\n{\r\n  \"detail\": {\r\n      \"eventName\": [\"ConsoleLogin\"]\r\n  }\r\n}\r\n```\r\n### 対象リージョン\r\n```txt\r\nap-northeast-1\r\nap-northeast-2\r\nap-northeast-3\r\nap-south-1\r\nap-southeast-1\r\nap-southeast-2\r\nca-central-1\r\neu-central-1\r\neu-north-1\r\neu-west-1\r\neu-west-2\r\neu-west-3\r\nsa-east-1\r\nus-east-1\r\nus-east-2\r\nus-west-1\r\nus-west-2\r\n```\r\n\r\n上記設定を行うことで各リージョンで自動的に EventBridge ルール作成が行われます。\r\nたったこれだけで ConsoleLogin 検知が可能...便利だ。。。\r\n\r\n## 通知内容\r\n\r\n以下の内容は通知より確認が可能です。\r\nRegion / Event ID があるので CloudTrail ログも検索がしやすく情報が薄いということはなさそうですね。\r\n\r\n- Region\r\n- Account ID\r\n- User identity\r\n- User agent\r\n- Login to\r\n- Login attempt\r\n- Event ID\r\n- Event time\r\n\r\n## 参考資料\r\n[1] AWS User Notifications - https://aws.amazon.com/jp/notifications/", "reactions": {"url": "https://api.github.com/repos/kemu3007/portal/issues/67/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kemu3007/portal/issues/67/timeline", "performed_via_github_app": null, "state_reason": null}