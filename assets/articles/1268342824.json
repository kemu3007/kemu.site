{"url": "https://api.github.com/repos/kemu3007/portal/issues/55", "repository_url": "https://api.github.com/repos/kemu3007/portal", "labels_url": "https://api.github.com/repos/kemu3007/portal/issues/55/labels{/name}", "comments_url": "https://api.github.com/repos/kemu3007/portal/issues/55/comments", "events_url": "https://api.github.com/repos/kemu3007/portal/issues/55/events", "html_url": "https://github.com/kemu3007/portal/issues/55", "id": 1268342824, "node_id": "I_kwDOG7qoq85LmWAo", "number": 55, "title": "AWS CodePipelineとGitHubを連携させてECRにイメージをPushする", "user": {"login": "kemu3007", "id": 29157528, "node_id": "MDQ6VXNlcjI5MTU3NTI4", "avatar_url": "https://avatars.githubusercontent.com/u/29157528?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kemu3007", "html_url": "https://github.com/kemu3007", "followers_url": "https://api.github.com/users/kemu3007/followers", "following_url": "https://api.github.com/users/kemu3007/following{/other_user}", "gists_url": "https://api.github.com/users/kemu3007/gists{/gist_id}", "starred_url": "https://api.github.com/users/kemu3007/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kemu3007/subscriptions", "organizations_url": "https://api.github.com/users/kemu3007/orgs", "repos_url": "https://api.github.com/users/kemu3007/repos", "events_url": "https://api.github.com/users/kemu3007/events{/privacy}", "received_events_url": "https://api.github.com/users/kemu3007/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 3898939400, "node_id": "LA_kwDOG7qoq87oZRgI", "url": "https://api.github.com/repos/kemu3007/portal/labels/article", "name": "article", "color": "C200E5", "default": false, "description": ""}, {"id": 3951278401, "node_id": "LA_kwDOG7qoq87rg7lB", "url": "https://api.github.com/repos/kemu3007/portal/labels/AWS", "name": "AWS", "color": "EE0471", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2022-06-11T18:19:06Z", "updated_at": "2022-06-12T09:33:32Z", "closed_at": null, "author_association": "OWNER", "active_lock_reason": null, "body": "\r\nGitHubのOAuth認証を利用し、CodePipelineと連携、CodeBuildを用いたECRへのAuto Pushを行ったのでやり方を紹介します。\r\n\r\n<svg viewBox=\"0 0 802.4409790039062 309.75\" style=\"max-width: 802.4409790039062px;\" height=\"309.75\" aria-labelledby=\"chart-title-mermaid-1655026366244 chart-desc-mermaid-1655026366244\" role=\"img\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" id=\"mermaid-1655026366244\"><title id=\"chart-title-mermaid-1655026366244\"></title><desc id=\"chart-desc-mermaid-1655026366244\"></desc><style>#mermaid-1655026366244 {font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1655026366244 .error-icon{fill:#552222;}#mermaid-1655026366244 .error-text{fill:#552222;stroke:#552222;}#mermaid-1655026366244 .edge-thickness-normal{stroke-width:2px;}#mermaid-1655026366244 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1655026366244 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1655026366244 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1655026366244 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1655026366244 .marker{fill:#333333;stroke:#333333;}#mermaid-1655026366244 .marker.cross{stroke:#333333;}#mermaid-1655026366244 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-1655026366244 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#333;}#mermaid-1655026366244 .cluster-label text{fill:#333;}#mermaid-1655026366244 .cluster-label span{color:#333;}#mermaid-1655026366244 .label text,#mermaid-1655026366244 span{fill:#333;color:#333;}#mermaid-1655026366244 .node rect,#mermaid-1655026366244 .node circle,#mermaid-1655026366244 .node ellipse,#mermaid-1655026366244 .node polygon,#mermaid-1655026366244 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1655026366244 .node .label{text-align:center;}#mermaid-1655026366244 .node.clickable{cursor:pointer;}#mermaid-1655026366244 .arrowheadPath{fill:#333333;}#mermaid-1655026366244 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1655026366244 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1655026366244 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1655026366244 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1655026366244 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1655026366244 .cluster text{fill:#333;}#mermaid-1655026366244 .cluster span{color:#333;}#mermaid-1655026366244 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1655026366244 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style><g transform=\"translate(0, 0)\"><marker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"9\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-pointEnd\"><path style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 0 L 10 5 L 0 10 z\"></path></marker><marker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"0\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-pointStart\"><path style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 5 L 10 10 L 10 0 z\"></path></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"11\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleEnd\"><circle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"></circle></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"-1\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleStart\"><circle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"></circle></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"12\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossEnd\"><path style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"></path></marker><marker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"-1\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossStart\"><path style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"></path></marker><g class=\"root\"><g class=\"clusters\"><g id=\"AWS\" class=\"cluster default\"><rect height=\"293.75\" width=\"501.44097900390625\" y=\"8\" x=\"293.00000381469727\" ry=\"0\" rx=\"0\" style=\"\"></rect><g transform=\"translate(529.03733253479, 13)\" class=\"cluster-label\"><foreignObject height=\"20\" width=\"29.366321563720703\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">AWS</span></div></foreignObject></g></g><g id=\"CodePipeline\" class=\"cluster default\"><rect height=\"168.75\" width=\"451.44097900390625\" y=\"28\" x=\"318.00000381469727\" ry=\"0\" rx=\"0\" style=\"\"></rect><g transform=\"translate(497.25781631469727, 33)\" class=\"cluster-label\"><foreignObject height=\"20\" width=\"92.92535400390625\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">CodePipeline</span></div></foreignObject></g></g></g><g class=\"edgePaths\"><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-Developer LE-GitHub\" id=\"L-Developer-GitHub-0\" d=\"M95.265625,74.25L102.17245388031006,74.25C109.07928276062012,74.25,122.89294052124023,74.25,136.70659828186035,74.25C150.52025604248047,74.25,164.3339138031006,74.25,171.24074268341064,74.25L178.1475715637207,74.25\"></path><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-CodeBuild LE-CodeDeploy\" id=\"L-CodeBuild-CodeDeploy-0\" d=\"M429.79687881469727,126.11303050288174L437.9746856689453,124.34419208573479C446.15249252319336,122.57535366858782,462.50810623168945,119.03767683429392,488.6184940338135,114.27669431597606C514.7288818359375,109.51571179765823,550.5940437316895,103.53142359531644,568.5266246795654,100.53927949414555L586.4592056274414,97.54713539297465\"></path><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-CodeBuild LE-ECR\" id=\"L-CodeBuild-ECR-0\" d=\"M429.79687881469727,144.88696949711826L437.9746856689453,146.6558079142652C446.15249252319336,148.42464633141216,462.50810623168945,151.96232316570607,492.0117912462022,166.43949491618636C521.515476260715,180.91666666666666,564.1672325812445,206.33333333333334,585.4931107415093,219.04166666666666L606.8189889017741,231.75\"></path><path marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-GitHub LE-CodePipeline\" id=\"L-GitHub-CodePipeline-0\" d=\"M243.00000381469727,74.25L247.16667048136392,74.25C251.3333371480306,74.25,259.66667048136395,74.25,268.00000381469727,74.25C276.3333371480306,74.25,284.66667048136395,74.25,293.00000381469727,74.25C301.3333371480306,74.25,309.66667048136395,74.25,313.8333371480306,74.25L318.00000381469727,74.25\"></path></g><g class=\"edgeLabels\"><g transform=\"translate(136.70659828186035, 74.25)\" class=\"edgeLabel\"><g transform=\"translate(-16.44097328186035, -10)\" class=\"label\"><foreignObject height=\"20\" width=\"32.8819465637207\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\">push</span></div></foreignObject></g></g><g transform=\"translate(478.86371994018555, 115.5)\" class=\"edgeLabel\"><g transform=\"translate(-24.06684112548828, -10)\" class=\"label\"><foreignObject height=\"20\" width=\"48.13368225097656\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\">trigger</span></div></foreignObject></g></g><g transform=\"translate(478.86371994018555, 155.5)\" class=\"edgeLabel\"><g transform=\"translate(-16.44097328186035, -10)\" class=\"label\"><foreignObject height=\"20\" width=\"32.8819465637207\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\">push</span></div></foreignObject></g></g><g class=\"edgeLabel\"><g transform=\"translate(0, 0)\" class=\"label\"><foreignObject height=\"0\" width=\"0\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"edgeLabel\"></span></div></foreignObject></g></g></g><g class=\"nodes\"><g transform=\"translate(636.1857719421387, 249.25)\" id=\"flowchart-ECR-4224\" class=\"node default default\"><rect height=\"35\" width=\"216.5104217529297\" y=\"-17.5\" x=\"-108.25521087646484\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-100.75521087646484, -10)\" style=\"\" class=\"label\"><foreignObject height=\"20\" width=\"201.5104217529297\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">Elastic Container Repository</span></div></foreignObject></g></g><g transform=\"translate(636.1857719421387, 89.25)\" id=\"flowchart-CodeDeploy-4228\" class=\"node default default\"><rect height=\"35\" width=\"99.45313262939453\" y=\"-17.5\" x=\"-49.726566314697266\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-42.226566314697266, -10)\" style=\"\" class=\"label\"><foreignObject height=\"20\" width=\"84.45313262939453\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">CodeDeploy</span></div></foreignObject></g></g><g transform=\"translate(386.39844131469727, 135.5)\" id=\"flowchart-CodeBuild-4227\" class=\"node default default\"><rect height=\"35\" width=\"86.796875\" y=\"-17.5\" x=\"-43.3984375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-35.8984375, -10)\" style=\"\" class=\"label\"><foreignObject height=\"20\" width=\"71.796875\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">CodeBuild</span></div></foreignObject></g></g><g transform=\"translate(51.6328125, 74.25)\" id=\"flowchart-Developer-4225\" class=\"node default\"><rect height=\"35\" width=\"87.265625\" y=\"-17.5\" x=\"-43.6328125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-36.1328125, -10)\" style=\"\" class=\"label\"><foreignObject height=\"20\" width=\"72.265625\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">Developer</span></div></foreignObject></g></g><g transform=\"translate(210.57378768920898, 74.25)\" id=\"flowchart-GitHub-4226\" class=\"node default default\"><rect height=\"35\" width=\"64.85243225097656\" y=\"-17.5\" x=\"-32.42621612548828\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"></rect><g transform=\"translate(-24.92621612548828, -10)\" style=\"\" class=\"label\"><foreignObject height=\"20\" width=\"49.85243225097656\"><div style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"><span class=\"nodeLabel\">GitHub</span></div></foreignObject></g></g></g></g></g></svg>\r\n\r\n\r\nOAuth認証を利用することで、デベロッパーはAWSへのトークンを手動で管理する必要がなくなり、CodeBuild以降の権限管理はAWSのフレームワークを利用できるため完全にトークンレスになります。\r\n\r\n## GitHubとAWS CodePipeline連携\r\n\r\nOAuth認証を利用します。\r\n\r\n`CodePipeline > 接続 > 接続を作成` から連携を作成することができます。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/173198376-c5593755-f6a8-45d3-a084-0b0aa54b9727.png)\r\n\r\n## Elastic Container Registory, CodeBuildの用意\r\n\r\nCodePipelineの設定に必要になるため、先にECRの初期設定、CodeBuildの作成を行います。\r\n\r\n### Elastic Container Registory\r\n\r\n`Amazon ECR > レポジトリを作成` からレポジトリを作成します。今回はPrivateイメージを想定します。\r\n\r\n\r\nGitHubのOAuth認証を利用し、CodePipelineと連携、CodeBuildを用いたECRへのAuto Pushを行ったのでやり方を紹介します。\r\n\r\n## GitHubとAWS CodePipeline連携\r\n\r\nOAuth認証を利用します。\r\n\r\n`CodePipeline > 接続 > 接続を作成` から連携を作成することができます。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/173198376-c5593755-f6a8-45d3-a084-0b0aa54b9727.png)\r\n\r\n## Elastic Container Registory, CodeBuildの用意\r\n\r\nCodePipelineの設定に必要になるため、先にECRの初期設定、CodeBuildの作成を行います。\r\n\r\n### Elastic Container Registory\r\n\r\n`Amazon ECR > レポジトリを作成` からレポジトリを作成します。今回はPrivateイメージを想定します。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/173199828-f633c796-47b1-4c37-82ea-bb1d7ae18540.png)\r\n\r\n### CodeBuildの設定\r\n\r\n`CodeBuild > プロジェクトの作成`\r\n\r\n今回はDockerイメージの構築を行うため、特権付与を行います。また、buildspecファイルを利用する形にしてください。\r\nその他、イメージ, ログの管理などに関しては好きなように設定してOKです。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/173199385-9857e08e-2158-4292-8ee2-b501d8a5a7b5.png)\r\n## IAMの設定を行う\r\n\r\n\r\n## CodePipelineの作成\r\n\r\n`CodePipeline　> パイプラインを作成する`\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/173198769-407d678d-3523-4232-9170-a142b456f062.png)\r\n![image](https://user-images.githubusercontent.com/29157528/173198785-a516c306-894c-4251-acb5-df134830d5a6.png)\r\n\r\n先ほど作成した接続に基づいて、利用するレポジトリ、リリースを行うブランチについて選択します。\r\n\r\n### CodeBuildの設定\r\n\r\n`CodeBuild > プロジェクトの作成`\r\n\r\n今回はDockerイメージの構築を行うため、特権付与を行います。また、buildspecファイルを利用する形にしてください。\r\nその他、イメージ, ログの管理などに関しては好きなように設定してOKです。\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/173199385-9857e08e-2158-4292-8ee2-b501d8a5a7b5.png)\r\n\r\n## IAMの設定を行う\r\n\r\n`IAM > ロール > codebuild-*****`\r\n\r\nCodeBuildで作成した/利用しているロールにECRへの権限を付与する必要があります。\r\n\r\n今回の動作確認では`アクセス許可を追加 > ポリシーをアタッチ` からAmazonEC2ContainerRegistryFullAccessを付与しました。\r\n\r\n## CodePipelineの作成\r\n\r\n`CodePipeline　> パイプラインを作成する`\r\n\r\n![image](https://user-images.githubusercontent.com/29157528/173198769-407d678d-3523-4232-9170-a142b456f062.png)\r\n![image](https://user-images.githubusercontent.com/29157528/173198785-a516c306-894c-4251-acb5-df134830d5a6.png)\r\n\r\n先ほど作成した接続, CodeBuild, ECRに基づいて、利用するレポジトリ、リリースを行うブランチについて選択します。\r\n\r\nデプロイステップに関しては今回スキップします。\r\n\r\n## buildspec.yml\r\n\r\nbuildspec.ymlを以下のような形で作成し、レポジトリ配下に作成します。\r\n\r\n```yml\r\nversion: 0.2\r\nphases:\r\n  pre_build:\r\n    commands:\r\n      - aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin *****.dkr.ecr.ap-northeast-1.amazonaws.com\r\n  build:\r\n    commands:\r\n      - docker build -t container-image . \r\n  post_build:\r\n    commands:\r\n      - docker tag container-image *****.dkr.ecr.ap-northeast-1.amazonaws.com/container-image:latest\r\n      - docker tag container-image *****.dkr.ecr.ap-northeast-1.amazonaws.com/container-image:$CODEBUILD_RESOLVED_SOURCE_VERSION\r\n      - docker push -a *****.dkr.ecr.ap-northeast-1.amazonaws.com/container-image\r\n```\r\n\r\n`$CODEBUILD_RESOLVED_SOURCE_VERSION` などの利用可能な環境変数は以下のページから確認できます。\r\n\r\n[ビルド環境の環境変数](https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/build-env-ref-env-vars.html)\r\n\r\n上記設定によりECRにAuto Pushされます。次回はPushしたECRイメージからECSへのデプロイを行います。\r\n\r\n", "reactions": {"url": "https://api.github.com/repos/kemu3007/portal/issues/55/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/kemu3007/portal/issues/55/timeline", "performed_via_github_app": null, "state_reason": null}