<!DOCTYPE html>
<html lang="ja">
  <head>
    <script>
      if (!window.navigator.userAgent.includes("Googlebot")) {
        window.location.href=window.location.origin + '?to=' + window.location.pathname + window.location.hash
      }
    </script>
    <meta charset="utf-8" />
    <title>フロントエンドのテストを書く(スナップショットテスト編) | kemu tech blog</title>
    <base href="/" />
    <meta name="description" content=" 環境Angular 13, node 16今回はjestを利用するためデフォルトで入っているKarmaを削除しますshnpm run ng add @briebug/jest-schematic参考: https://github.com/briebug/jest-schematic テストを書く" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:title" content="フロントエンドのテストを書く(スナップショットテスト編) | kemu tech blog" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content=" 環境Angular 13, node 16今回はjestを利用するためデフォルトで入っているKarmaを削除しますshnpm run ng add @briebug/jest-schematic参考: https://github.com/briebug/jest-schematic テストを書く" />
    <meta property="og:url" content="https://portal.kemu.site" />
    <meta
      property="og:image"
      content="https://portal.kemu.site/assets/images/1160543297.png"
    />
    <meta property="og:locale" content="ja_JP" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:image"
      content="https://portal.kemu.site/assets/images/1160543297.png"
    />
    <meta name="twitter:description" content=" 環境Angular 13, node 16今回はjestを利用するためデフォルトで入っているKarmaを削除しますshnpm run ng add @briebug/jest-schematic参考: https://github.com/briebug/jest-schematic テストを書く" />
    <meta name="twitter:title" content="フロントエンドのテストを書く(スナップショットテスト編) | kemu tech blog" />
    <meta name="twitter:url" content="https://twitter.com/kemu43" />
    <link
      rel="icon"
      type="image/x-icon"
      href="https://avatars.githubusercontent.com/u/29157528?v=4"
    />
  </head>
  <body>
    <a href="/">home</a>
    <a href="/blog/">blog</a>
    <a href="/log/">log</a>
    <a href="/tools/">tools</a>
    <a href="/contact/">contact</a>
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr />
    <h2>フロントエンドのテストを書く(スナップショットテスト編)</h2> ### 環境
Angular 13, node 16

今回はjestを利用するためデフォルトで入っているKarmaを削除します
```sh
npm run ng add @briebug/jest-schematic
```

参考: https://github.com/briebug/jest-schematic

### テストを書く
- app.component.spec.ts

```ts
  it('snapshot test', () => {
    const fixture = TestBed.createComponent(AppComponent);
    fixture.detectChanges();
    const compiled = fixture.nativeElement;
    expect(compiled).toMatchSnapshot();
  })
```

### 実行

`npm run test`でテストを実行する際、既存のスナップショットがない、もしくは` --update-snapshot`がオプションで付けられた場合、`__snapshots__`ディレクトリが作成されます。以下はその例です。

- `__snapshots__/app.component.spec.ts.snap`

```ts
// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`AppComponent snapshot test 1`] = `
<div
  id="root2"
>
  <mat-toolbar>
    <mat-toolbar-row
      style="padding: 0 16px 0 0;"
    >
      <button
        mat-button=""
      >
...
```
テスト失敗時には以下のように表示されます。

```bash
    expect(received).toMatchSnapshot()

    Snapshot name: `AppComponent snapshot test 1`

    - Snapshot  - 1
    + Received  + 1

    @@ -1,11 +1,11 @@
      <div
        id="root2"
      >
        <mat-toolbar>
          <mat-toolbar-row
    -       style="padding: 0 16px 0 0;"
    +       style="padding: 1 16px 0 0;"
          >
            <button
              mat-button=""
            >
              <mat-icon>

      33 |     fixture.detectChanges();
      34 |     const compiled = fixture.nativeElement;
    > 35 |     expect(compiled).toMatchSnapshot();
         |                      ^
      36 |   })
      37 | });
      38 |

      at src/app/app.component.spec.ts:35:22
      at ZoneDelegate.Object.<anonymous>.ZoneDelegate.invoke (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:407:30)
      at ProxyZoneSpec.Object.<anonymous>.ProxyZoneSpec.onInvoke (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:3765:43)
      at ZoneDelegate.Object.<anonymous>.ZoneDelegate.invoke (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:406:56)
      at Zone.Object.<anonymous>.Zone.run (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:167:47)
      at Object.wrappedFunc (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:4250:34)

 › 1 snapshot failed.
Snapshot Summary
 › 1 snapshot failed from 1 test suite. Inspect your code changes or re-run jest with `-u` to update them.

Test Suites: 1 failed, 1 total
Tests:       1 failed, 2 passed, 3 total
Snapshots:   1 failed, 1 total
Time:        1.667 s, estimated 2 s
Ran all test suites.
```

### テストの意味

フロントエンドに対する修正を行った際、修正点の影響を軽くassertすることができます。

問題点は以下の通りです。

- cssをstyle形式でインライン記述しないとassertできない
- 条件に応じて表示されるコンポーネントに関しては別途patchしてassertする必要あり(snapshotを毎回とっていると遅いので)

cssに関しては顕著でテストで見るためにはインラインで記述する必要があるけれどcssをインラインで記述して可読性を下げたくないというジレンマに襲われます。

### 注意点

`__snapshots__` ディレクトリは見た目はちょっとあれですがgitに管理させる必要があります。

### 総評

まあ過度な期待はせずに軽く分かればいいかなというレベルのテストです。 <hr /> meta: {'url': 'https://api.github.com/repos/kemu3007/portal/issues/9', 'repository_url': 'https://api.github.com/repos/kemu3007/portal', 'labels_url': 'https://api.github.com/repos/kemu3007/portal/issues/9/labels{/name}', 'comments_url': 'https://api.github.com/repos/kemu3007/portal/issues/9/comments', 'events_url': 'https://api.github.com/repos/kemu3007/portal/issues/9/events', 'html_url': 'https://github.com/kemu3007/portal/issues/9', 'id': 1160543297, 'node_id': 'I_kwDOG7qoq85FLHxB', 'number': 9, 'title': 'フロントエンドのテストを書く(スナップショットテスト編)', 'user': {'login': 'kemu3007', 'id': 29157528, 'node_id': 'MDQ6VXNlcjI5MTU3NTI4', 'avatar_url': 'https://avatars.githubusercontent.com/u/29157528?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kemu3007', 'html_url': 'https://github.com/kemu3007', 'followers_url': 'https://api.github.com/users/kemu3007/followers', 'following_url': 'https://api.github.com/users/kemu3007/following{/other_user}', 'gists_url': 'https://api.github.com/users/kemu3007/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kemu3007/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kemu3007/subscriptions', 'organizations_url': 'https://api.github.com/users/kemu3007/orgs', 'repos_url': 'https://api.github.com/users/kemu3007/repos', 'events_url': 'https://api.github.com/users/kemu3007/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kemu3007/received_events', 'type': 'User', 'site_admin': False}, 'labels': [{'id': 3898939400, 'node_id': 'LA_kwDOG7qoq87oZRgI', 'url': 'https://api.github.com/repos/kemu3007/portal/labels/article', 'name': 'article', 'color': 'C200E5', 'default': False, 'description': ''}, {'id': 3900074882, 'node_id': 'LA_kwDOG7qoq87odmuC', 'url': 'https://api.github.com/repos/kemu3007/portal/labels/Angular', 'name': 'Angular', 'color': 'D93F0B', 'default': False, 'description': ''}], 'state': 'open', 'locked': False, 'assignee': None, 'assignees': [], 'milestone': None, 'comments': 0, 'created_at': '2022-03-06T07:47:02Z', 'updated_at': '2022-03-06T15:20:21Z', 'closed_at': None, 'author_association': 'OWNER', 'active_lock_reason': None, 'body': '### 環境\r\nAngular 13, node 16\r\n\r\n今回はjestを利用するためデフォルトで入っているKarmaを削除します\r\n```sh\r\nnpm run ng add @briebug/jest-schematic\r\n```\r\n\r\n参考: https://github.com/briebug/jest-schematic\r\n\r\n### テストを書く\r\n- app.component.spec.ts\r\n\r\n```ts\r\n  it(\'snapshot test\', () => {\r\n    const fixture = TestBed.createComponent(AppComponent);\r\n    fixture.detectChanges();\r\n    const compiled = fixture.nativeElement;\r\n    expect(compiled).toMatchSnapshot();\r\n  })\r\n```\r\n\r\n### 実行\r\n\r\n`npm run test`でテストを実行する際、既存のスナップショットがない、もしくは` --update-snapshot`がオプションで付けられた場合、`__snapshots__`ディレクトリが作成されます。以下はその例です。\r\n\r\n- `__snapshots__/app.component.spec.ts.snap`\r\n\r\n```ts\r\n// Jest Snapshot v1, https://goo.gl/fbAQLP\r\n\r\nexports[`AppComponent snapshot test 1`] = `\r\n<div\r\n  id="root2"\r\n>\r\n  <mat-toolbar>\r\n    <mat-toolbar-row\r\n      style="padding: 0 16px 0 0;"\r\n    >\r\n      <button\r\n        mat-button=""\r\n      >\r\n...\r\n```\r\nテスト失敗時には以下のように表示されます。\r\n\r\n```bash\r\n    expect(received).toMatchSnapshot()\r\n\r\n    Snapshot name: `AppComponent snapshot test 1`\r\n\r\n    - Snapshot  - 1\r\n    + Received  + 1\r\n\r\n    @@ -1,11 +1,11 @@\r\n      <div\r\n        id="root2"\r\n      >\r\n        <mat-toolbar>\r\n          <mat-toolbar-row\r\n    -       style="padding: 0 16px 0 0;"\r\n    +       style="padding: 1 16px 0 0;"\r\n          >\r\n            <button\r\n              mat-button=""\r\n            >\r\n              <mat-icon>\r\n\r\n      33 |     fixture.detectChanges();\r\n      34 |     const compiled = fixture.nativeElement;\r\n    > 35 |     expect(compiled).toMatchSnapshot();\r\n         |                      ^\r\n      36 |   })\r\n      37 | });\r\n      38 |\r\n\r\n      at src/app/app.component.spec.ts:35:22\r\n      at ZoneDelegate.Object.<anonymous>.ZoneDelegate.invoke (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:407:30)\r\n      at ProxyZoneSpec.Object.<anonymous>.ProxyZoneSpec.onInvoke (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:3765:43)\r\n      at ZoneDelegate.Object.<anonymous>.ZoneDelegate.invoke (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:406:56)\r\n      at Zone.Object.<anonymous>.Zone.run (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:167:47)\r\n      at Object.wrappedFunc (node_modules/zone.js/bundles/zone-testing-bundle.umd.js:4250:34)\r\n\r\n › 1 snapshot failed.\r\nSnapshot Summary\r\n › 1 snapshot failed from 1 test suite. Inspect your code changes or re-run jest with `-u` to update them.\r\n\r\nTest Suites: 1 failed, 1 total\r\nTests:       1 failed, 2 passed, 3 total\r\nSnapshots:   1 failed, 1 total\r\nTime:        1.667 s, estimated 2 s\r\nRan all test suites.\r\n```\r\n\r\n### テストの意味\r\n\r\nフロントエンドに対する修正を行った際、修正点の影響を軽くassertすることができます。\r\n\r\n問題点は以下の通りです。\r\n\r\n- cssをstyle形式でインライン記述しないとassertできない\r\n- 条件に応じて表示されるコンポーネントに関しては別途patchしてassertする必要あり(snapshotを毎回とっていると遅いので)\r\n\r\ncssに関しては顕著でテストで見るためにはインラインで記述する必要があるけれどcssをインラインで記述して可読性を下げたくないというジレンマに襲われます。\r\n\r\n### 注意点\r\n\r\n`__snapshots__` ディレクトリは見た目はちょっとあれですがgitに管理させる必要があります。\r\n\r\n### 総評\r\n\r\nまあ過度な期待はせずに軽く分かればいいかなというレベルのテストです。', 'reactions': {'url': 'https://api.github.com/repos/kemu3007/portal/issues/9/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}, 'timeline_url': 'https://api.github.com/repos/kemu3007/portal/issues/9/timeline', 'performed_via_github_app': None}
    <hr />
    <a href="/tools/base64/">Base64 Encoder/Decoder</a>
    <a href="/tools/jsonFormatter/">JSON Formatter</a>
    <a href="/tools/realtime/">REALTIME</a>
    <a href="/tools/jsonTyper/">JSON Typer</a>
    <a href="/tools/userInfo/">IP Addreass Checker</a>
  
    <footer class="my-5 footer">
      <div class="d-flex justify-content-end">
        <span style="font-size: 24px">
          <a href="https://github.com/kemu3007"><i class="bi bi-github fa-sm"></i></a>
          <a class="ms-2" href="https://twitter.com/kemu43"><i class="bi bi-twitter"></i></a>
          <a class="mx-2" href="https://portal.kemu.site/doc/"><i class="bi bi-book"></i></a>
        </span>
      </div>
      <div class="d-flex justify-content-center">
        <span class="text-muted">Copyright ©️ 2017-2022 kemu All Rights Reserved.</span>
      </div>
    </footer>
  </body>
</html>
