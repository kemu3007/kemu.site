<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>kemu tech blog | Django Rest Framework OpenAPIドキュメントを起こす</title>
    <base href="/" />
    <meta name="description" content="APIからOpenAPIドキュメントを生成する機会があったのでメモDRF自体に generateschema というコマンドが存在しているためzsh$ python manage.py generat" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:title" content="kemu tech blog | Django Rest Framework OpenAPIドキュメントを起こす" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="APIからOpenAPIドキュメントを生成する機会があったのでメモDRF自体に generateschema というコマンドが存在しているためzsh$ python manage.py generat" />
    <meta property="og:url" content="https://portal.kemu.site" />
    <meta
      property="og:image"
      content="https://portal.kemu.site/assets/images/1169430844.png"
    />
    <meta property="og:locale" content="ja_JP" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:image"
      content="https://portal.kemu.site/assets/images/1169430844.png"
    />
    <meta name="twitter:description" content="APIからOpenAPIドキュメントを生成する機会があったのでメモDRF自体に generateschema というコマンドが存在しているためzsh$ python manage.py generat" />
    <meta name="twitter:title" content="kemu tech blog | Django Rest Framework OpenAPIドキュメントを起こす" />
    <meta name="twitter:url" content="https://twitter.com/kemu43" />
    <link
      rel="icon"
      type="image/x-icon"
      href="https://avatars.githubusercontent.com/u/29157528?v=4"
    />
  </head>
  <body>
    <a href="/">home</a>
    <a href="/blog">blog</a>
    <a href="/log">log</a>
    <a href="/tools">tools</a>
    <a href="/contact">contact</a>
    <hr />
    <h2>Django Rest Framework OpenAPIドキュメントを起こす</h2> APIからOpenAPIドキュメントを生成する機会があったのでメモ

DRF自体に `generateschema` というコマンドが存在しているため

```zsh
$ python manage.py generateschema > schema.yml
```

と実行するだけでスキーマファイルが生成されます。

<details>
<summary>schema.yml</summary>

```yml
openapi: 3.0.2
info:
  title: ''
  version: ''
paths:
  /api/v1/article/:
    get:
      operationId: listArticles
      description: ''
      parameters: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Article'
          description: ''
      tags:
      - api
    post:
      operationId: createArticle
      description: ''
      parameters: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Article'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/Article'
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/Article'
      responses:
        '201':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Article'
          description: ''
      tags:
      - api
  /api/v1/article/{id}/:
    get:
      operationId: retrieveArticle
      description: ''
      parameters:
      - name: id
        in: path
        required: true
        description: A unique integer value identifying this article.
        schema:
          type: string
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Article'
          description: ''
      tags:
      - api
components:
  schemas:
    Article:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
        subject:
          type: string
          maxLength: 255
        body:
          type: string
        created_at:
          type: string
          format: date-time
          readOnly: true
        updated_at:
          type: string
          format: date-time
          readOnly: true
        is_draft:
          type: boolean
      required:
      - subject

```
</details>

<img width="713" alt="スクリーンショット 2022-03-15 18 27 49" src="https://user-images.githubusercontent.com/29157528/158347543-edb65a5a-1148-42dc-9e5e-ea2b325c2ef7.png">

それほど複雑でなく入力の型と出力の型が一致するようなプロジェクトであればDRFのコマンドで十分かと思います。

ただ出力が status_code=201 のみのAPIなどが存在する場合機能しなくなります。

```py
class ArticleViewSets(ModelViewSet):
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    http_method_names = ["get", "post"]

    def create(self, *args, **kwargs):
        return Response(status=201)
```

↓Response(status=201)が返却されるがスキーマには反映されない。

<img width="703" alt="スクリーンショット 2022-03-15 18 34 22" src="https://user-images.githubusercontent.com/29157528/158348870-530ea38a-20e8-4f44-9c63-915683d722b2.png">

---

[drf-spectacular](https://github.com/tfranzel/drf-spectacular)を利用して明示的に入力/出力シリアライザを記載することでスキーマの出力を容易に行うことができます。

install 
```zsh
$ pip install drf-spectacular
```

settings.py
```py
INSTALLED_APPS = [
  ...
  'drf_spectacular'
]
REST_FRAMEWORK = {
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}
```

viewsets.py
```py
class NoInputSerializer(Serializer):
    """スキーマ出力用シリアライザ"""


class ArticleSerializer(ModelSerializer):
    class Meta:
        model = Article
        fields = ["id", "subject", "body", "created_at", "updated_at", "is_draft"]


@extend_schema_view(
    list=extend_schema(responses=ArticleSerializer),
    create=extend_schema(request=ArticleSerializer, responses=NoInputSerializer)
)
class ArticleViewSets(ModelViewSet):
    queryset = Article.objects.all()
    serializer_class = ArticleSerializer
    http_method_names = ["get", "post"]

    def create(self, *args, **kwargs):
        return Response(status=200)
```
出力作業
```zsh
$ python manage.py spectacular --file schema.yml
```

<details>
<summary> schema.yml </summary>

```yml
openapi: 3.0.3
info:
  title: ''
  version: 0.0.0
paths:
  /api/v1/article/:
    get:
      operationId: api_v1_article_list
      tags:
      - api
      security:
      - cookieAuth: []
      - basicAuth: []
      - {}
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Article'
          description: ''
    post:
      operationId: api_v1_article_create
      tags:
      - api
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Article'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/Article'
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/Article'
        required: true
      security:
      - cookieAuth: []
      - basicAuth: []
      - {}
      responses:
        '201':
          description: No response body
  /api/v1/article/{id}/:
    get:
      operationId: api_v1_article_retrieve
      parameters:
      - in: path
        name: id
        schema:
          type: integer
        description: A unique integer value identifying this article.
        required: true
      tags:
      - api
      security:
      - cookieAuth: []
      - basicAuth: []
      - {}
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Article'
          description: ''
components:
  schemas:
    Article:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
        subject:
          type: string
          title: 題名
          maxLength: 255
        body:
          type: string
          title: 記事
        created_at:
          type: string
          format: date-time
          readOnly: true
          title: 作成日
        updated_at:
          type: string
          format: date-time
          readOnly: true
          title: 更新日
        is_draft:
          type: boolean
          title: 下書き状態
      required:
      - created_at
      - id
      - subject
      - updated_at
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
    cookieAuth:
      type: apiKey
      in: cookie
      name: sessionid
```
</details>

指定した形式で出力されていることがわかります。

<img width="711" alt="スクリーンショット 2022-03-15 18 47 58" src="https://user-images.githubusercontent.com/29157528/158351424-cfa4b177-5cf7-442f-96d3-b3c8e1bb059f.png">

---

これでOpenAPIドキュメントの生成ができました。
OpenAPIドキュメントを生成することでフロントエンドの型生成、APIのドキュメントにも利用することができるので積極的にやっていきましょう。

gitlabの場合はファイル名を`swagger.yml` という名前で置いてあげることでswagger形式で見ることができるようになります。
githubにも導入されてほしいなー(最近gitlab機能の取り込みみたいなことが多いのでちょっと期待。 <hr /> meta: {'url': 'https://api.github.com/repos/kemu3007/portal/issues/16', 'repository_url': 'https://api.github.com/repos/kemu3007/portal', 'labels_url': 'https://api.github.com/repos/kemu3007/portal/issues/16/labels{/name}', 'comments_url': 'https://api.github.com/repos/kemu3007/portal/issues/16/comments', 'events_url': 'https://api.github.com/repos/kemu3007/portal/issues/16/events', 'html_url': 'https://github.com/kemu3007/portal/issues/16', 'id': 1169430844, 'node_id': 'I_kwDOG7qoq85FtBk8', 'number': 16, 'title': 'Django Rest Framework OpenAPIドキュメントを起こす', 'user': {'login': 'kemu3007', 'id': 29157528, 'node_id': 'MDQ6VXNlcjI5MTU3NTI4', 'avatar_url': 'https://avatars.githubusercontent.com/u/29157528?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kemu3007', 'html_url': 'https://github.com/kemu3007', 'followers_url': 'https://api.github.com/users/kemu3007/followers', 'following_url': 'https://api.github.com/users/kemu3007/following{/other_user}', 'gists_url': 'https://api.github.com/users/kemu3007/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kemu3007/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kemu3007/subscriptions', 'organizations_url': 'https://api.github.com/users/kemu3007/orgs', 'repos_url': 'https://api.github.com/users/kemu3007/repos', 'events_url': 'https://api.github.com/users/kemu3007/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kemu3007/received_events', 'type': 'User', 'site_admin': False}, 'labels': [{'id': 3898939400, 'node_id': 'LA_kwDOG7qoq87oZRgI', 'url': 'https://api.github.com/repos/kemu3007/portal/labels/article', 'name': 'article', 'color': 'C200E5', 'default': False, 'description': ''}, {'id': 3900075763, 'node_id': 'LA_kwDOG7qoq87odm7z', 'url': 'https://api.github.com/repos/kemu3007/portal/labels/Django', 'name': 'Django', 'color': '5FC353', 'default': False, 'description': ''}], 'state': 'open', 'locked': False, 'assignee': None, 'assignees': [], 'milestone': None, 'comments': [], 'created_at': '2022-03-15T09:53:45Z', 'updated_at': '2022-03-15T09:56:56Z', 'closed_at': None, 'author_association': 'OWNER', 'active_lock_reason': None, 'body': 'APIからOpenAPIドキュメントを生成する機会があったのでメモ\r\n\r\nDRF自体に `generateschema` というコマンドが存在しているため\r\n\r\n```zsh\r\n$ python manage.py generateschema > schema.yml\r\n```\r\n\r\nと実行するだけでスキーマファイルが生成されます。\r\n\r\n<details>\r\n<summary>schema.yml</summary>\r\n\r\n```yml\r\nopenapi: 3.0.2\r\ninfo:\r\n  title: \'\'\r\n  version: \'\'\r\npaths:\r\n  /api/v1/article/:\r\n    get:\r\n      operationId: listArticles\r\n      description: \'\'\r\n      parameters: []\r\n      responses:\r\n        \'200\':\r\n          content:\r\n            application/json:\r\n              schema:\r\n                type: array\r\n                items:\r\n                  $ref: \'#/components/schemas/Article\'\r\n          description: \'\'\r\n      tags:\r\n      - api\r\n    post:\r\n      operationId: createArticle\r\n      description: \'\'\r\n      parameters: []\r\n      requestBody:\r\n        content:\r\n          application/json:\r\n            schema:\r\n              $ref: \'#/components/schemas/Article\'\r\n          application/x-www-form-urlencoded:\r\n            schema:\r\n              $ref: \'#/components/schemas/Article\'\r\n          multipart/form-data:\r\n            schema:\r\n              $ref: \'#/components/schemas/Article\'\r\n      responses:\r\n        \'201\':\r\n          content:\r\n            application/json:\r\n              schema:\r\n                $ref: \'#/components/schemas/Article\'\r\n          description: \'\'\r\n      tags:\r\n      - api\r\n  /api/v1/article/{id}/:\r\n    get:\r\n      operationId: retrieveArticle\r\n      description: \'\'\r\n      parameters:\r\n      - name: id\r\n        in: path\r\n        required: true\r\n        description: A unique integer value identifying this article.\r\n        schema:\r\n          type: string\r\n      responses:\r\n        \'200\':\r\n          content:\r\n            application/json:\r\n              schema:\r\n                $ref: \'#/components/schemas/Article\'\r\n          description: \'\'\r\n      tags:\r\n      - api\r\ncomponents:\r\n  schemas:\r\n    Article:\r\n      type: object\r\n      properties:\r\n        id:\r\n          type: integer\r\n          readOnly: true\r\n        subject:\r\n          type: string\r\n          maxLength: 255\r\n        body:\r\n          type: string\r\n        created_at:\r\n          type: string\r\n          format: date-time\r\n          readOnly: true\r\n        updated_at:\r\n          type: string\r\n          format: date-time\r\n          readOnly: true\r\n        is_draft:\r\n          type: boolean\r\n      required:\r\n      - subject\r\n\r\n```\r\n</details>\r\n\r\n<img width="713" alt="スクリーンショット 2022-03-15 18 27 49" src="https://user-images.githubusercontent.com/29157528/158347543-edb65a5a-1148-42dc-9e5e-ea2b325c2ef7.png">\r\n\r\nそれほど複雑でなく入力の型と出力の型が一致するようなプロジェクトであればDRFのコマンドで十分かと思います。\r\n\r\nただ出力が status_code=201 のみのAPIなどが存在する場合機能しなくなります。\r\n\r\n```py\r\nclass ArticleViewSets(ModelViewSet):\r\n    queryset = Article.objects.all()\r\n    serializer_class = ArticleSerializer\r\n    http_method_names = ["get", "post"]\r\n\r\n    def create(self, *args, **kwargs):\r\n        return Response(status=201)\r\n```\r\n\r\n↓Response(status=201)が返却されるがスキーマには反映されない。\r\n\r\n<img width="703" alt="スクリーンショット 2022-03-15 18 34 22" src="https://user-images.githubusercontent.com/29157528/158348870-530ea38a-20e8-4f44-9c63-915683d722b2.png">\r\n\r\n---\r\n\r\n[drf-spectacular](https://github.com/tfranzel/drf-spectacular)を利用して明示的に入力/出力シリアライザを記載することでスキーマの出力を容易に行うことができます。\r\n\r\ninstall \r\n```zsh\r\n$ pip install drf-spectacular\r\n```\r\n\r\nsettings.py\r\n```py\r\nINSTALLED_APPS = [\r\n  ...\r\n  \'drf_spectacular\'\r\n]\r\nREST_FRAMEWORK = {\r\n    \'DEFAULT_SCHEMA_CLASS\': \'drf_spectacular.openapi.AutoSchema\',\r\n}\r\n```\r\n\r\nviewsets.py\r\n```py\r\nclass NoInputSerializer(Serializer):\r\n    """スキーマ出力用シリアライザ"""\r\n\r\n\r\nclass ArticleSerializer(ModelSerializer):\r\n    class Meta:\r\n        model = Article\r\n        fields = ["id", "subject", "body", "created_at", "updated_at", "is_draft"]\r\n\r\n\r\n@extend_schema_view(\r\n    list=extend_schema(responses=ArticleSerializer),\r\n    create=extend_schema(request=ArticleSerializer, responses=NoInputSerializer)\r\n)\r\nclass ArticleViewSets(ModelViewSet):\r\n    queryset = Article.objects.all()\r\n    serializer_class = ArticleSerializer\r\n    http_method_names = ["get", "post"]\r\n\r\n    def create(self, *args, **kwargs):\r\n        return Response(status=200)\r\n```\r\n出力作業\r\n```zsh\r\n$ python manage.py spectacular --file schema.yml\r\n```\r\n\r\n<details>\r\n<summary> schema.yml </summary>\r\n\r\n```yml\r\nopenapi: 3.0.3\r\ninfo:\r\n  title: \'\'\r\n  version: 0.0.0\r\npaths:\r\n  /api/v1/article/:\r\n    get:\r\n      operationId: api_v1_article_list\r\n      tags:\r\n      - api\r\n      security:\r\n      - cookieAuth: []\r\n      - basicAuth: []\r\n      - {}\r\n      responses:\r\n        \'200\':\r\n          content:\r\n            application/json:\r\n              schema:\r\n                type: array\r\n                items:\r\n                  $ref: \'#/components/schemas/Article\'\r\n          description: \'\'\r\n    post:\r\n      operationId: api_v1_article_create\r\n      tags:\r\n      - api\r\n      requestBody:\r\n        content:\r\n          application/json:\r\n            schema:\r\n              $ref: \'#/components/schemas/Article\'\r\n          application/x-www-form-urlencoded:\r\n            schema:\r\n              $ref: \'#/components/schemas/Article\'\r\n          multipart/form-data:\r\n            schema:\r\n              $ref: \'#/components/schemas/Article\'\r\n        required: true\r\n      security:\r\n      - cookieAuth: []\r\n      - basicAuth: []\r\n      - {}\r\n      responses:\r\n        \'201\':\r\n          description: No response body\r\n  /api/v1/article/{id}/:\r\n    get:\r\n      operationId: api_v1_article_retrieve\r\n      parameters:\r\n      - in: path\r\n        name: id\r\n        schema:\r\n          type: integer\r\n        description: A unique integer value identifying this article.\r\n        required: true\r\n      tags:\r\n      - api\r\n      security:\r\n      - cookieAuth: []\r\n      - basicAuth: []\r\n      - {}\r\n      responses:\r\n        \'200\':\r\n          content:\r\n            application/json:\r\n              schema:\r\n                $ref: \'#/components/schemas/Article\'\r\n          description: \'\'\r\ncomponents:\r\n  schemas:\r\n    Article:\r\n      type: object\r\n      properties:\r\n        id:\r\n          type: integer\r\n          readOnly: true\r\n        subject:\r\n          type: string\r\n          title: 題名\r\n          maxLength: 255\r\n        body:\r\n          type: string\r\n          title: 記事\r\n        created_at:\r\n          type: string\r\n          format: date-time\r\n          readOnly: true\r\n          title: 作成日\r\n        updated_at:\r\n          type: string\r\n          format: date-time\r\n          readOnly: true\r\n          title: 更新日\r\n        is_draft:\r\n          type: boolean\r\n          title: 下書き状態\r\n      required:\r\n      - created_at\r\n      - id\r\n      - subject\r\n      - updated_at\r\n  securitySchemes:\r\n    basicAuth:\r\n      type: http\r\n      scheme: basic\r\n    cookieAuth:\r\n      type: apiKey\r\n      in: cookie\r\n      name: sessionid\r\n```\r\n</details>\r\n\r\n指定した形式で出力されていることがわかります。\r\n\r\n<img width="711" alt="スクリーンショット 2022-03-15 18 47 58" src="https://user-images.githubusercontent.com/29157528/158351424-cfa4b177-5cf7-442f-96d3-b3c8e1bb059f.png">\r\n\r\n---\r\n\r\nこれでOpenAPIドキュメントの生成ができました。\r\nOpenAPIドキュメントを生成することでフロントエンドの型生成、APIのドキュメントにも利用することができるので積極的にやっていきましょう。\r\n\r\ngitlabの場合はファイル名を`swagger.yml` という名前で置いてあげることでswagger形式で見ることができるようになります。\r\ngithubにも導入されてほしいなー(最近gitlab機能の取り込みみたいなことが多いのでちょっと期待。', 'reactions': {'url': 'https://api.github.com/repos/kemu3007/portal/issues/16/reactions', 'total_count': 0, '+1': 0, '-1': 0, 'laugh': 0, 'hooray': 0, 'confused': 0, 'heart': 0, 'rocket': 0, 'eyes': 0}, 'timeline_url': 'https://api.github.com/repos/kemu3007/portal/issues/16/timeline', 'performed_via_github_app': None}
  </body>
  <script>
    if (!window.navigator.userAgent.includes("Googlebot")) {
      window.location.href=window.location.origin + '?to=' + window.location.pathname
    }
  </script>
</html>
